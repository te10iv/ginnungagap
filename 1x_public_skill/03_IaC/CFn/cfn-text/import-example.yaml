AWSTemplateFormatVersion: '2010-09-09'
Description: 'ImportValue Example - Using Outputs from after-advanced.yaml'

# ==========================================
# âœ… ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯ after-advanced.yaml ã®
#    Outputs ã‚’ ImportValue ã§å‚ç…§ã™ã‚‹ä¾‹
# ==========================================

Parameters:
  NetworkStackName:
    Type: String
    Default: myapp-dev-stack
    Description: Name of the network stack to import from

Resources:
  # ==========================================
  # æ–°ã—ã„EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
  # ==========================================
  AdditionalWebServer:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Sub '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2}}'
      InstanceType: t3.small
      
      # âœ… ä»–ã‚¹ã‚¿ãƒƒã‚¯ã®Public Subnetã‚’ä½¿ç”¨
      SubnetId: !Select 
        - 0
        - !Split 
          - ','
          - !ImportValue                                    # âœ… ImportValue ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
              Fn::Sub: '${NetworkStackName}-PublicSubnets'
      
      # âœ… ä»–ã‚¹ã‚¿ãƒƒã‚¯ã®Security Groupã‚’ä½¿ç”¨
      SecurityGroupIds:
        - !ImportValue                                      # âœ… ImportValue
            Fn::Sub: '${NetworkStackName}-WebSG'
      
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          yum update -y
          yum install -y httpd mysql
          systemctl start httpd
          systemctl enable httpd
          
          # âœ… ä»–ã‚¹ã‚¿ãƒƒã‚¯ã®DB Endpointã‚’ä½¿ç”¨
          DB_ENDPOINT="${ImportValue ${NetworkStackName}-DBEndpoint}"
          
          cat > /var/www/html/index.html <<EOF
          <html>
          <head><title>Additional Server</title></head>
          <body>
            <h1>Additional Web Server</h1>
            <p>Connected to DB: \${DB_ENDPOINT}</p>
            <p>Using imported network resources</p>
          </body>
          </html>
          EOF
      
      Tags:
        - Key: Name
          Value: additional-web-server

  # ==========================================
  # æ–°ã—ã„Lambda Function
  # ==========================================
  MyLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: db-query-function
      Runtime: python3.11
      Handler: index.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      
      # âœ… ä»–ã‚¹ã‚¿ãƒƒã‚¯ã®Private Subnetã§èµ·å‹•
      VpcConfig:
        SubnetIds: !Split
          - ','
          - !ImportValue
              Fn::Sub: '${NetworkStackName}-PrivateSubnets'
        
        # âœ… ä»–ã‚¹ã‚¿ãƒƒã‚¯ã®DB Security Groupã‚’ä½¿ç”¨
        SecurityGroupIds:
          - !ImportValue
              Fn::Sub: '${NetworkStackName}-DBSG'
      
      Environment:
        Variables:
          # âœ… ä»–ã‚¹ã‚¿ãƒƒã‚¯ã®DB Endpointã‚’ç’°å¢ƒå¤‰æ•°ã§æ¸¡ã™
          DB_ENDPOINT: !ImportValue
            Fn::Sub: '${NetworkStackName}-DBEndpoint'
      
      Code:
        ZipFile: |
          import os
          import pymysql
          
          def lambda_handler(event, context):
              db_endpoint = os.environ['DB_ENDPOINT']
              print(f"Connecting to: {db_endpoint}")
              
              # DBæ¥ç¶šå‡¦ç†
              # connection = pymysql.connect(host=db_endpoint, ...)
              
              return {
                  'statusCode': 200,
                  'body': f'Connected to {db_endpoint}'
              }

  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole

# ==========================================
# Outputs
# ==========================================
Outputs:
  AdditionalServerIP:
    Description: Additional Web Server Public IP
    Value: !GetAtt AdditionalWebServer.PublicIp
  
  LambdaFunctionArn:
    Description: Lambda Function ARN
    Value: !GetAtt MyLambdaFunction.Arn
  
  UsedNetworkStack:
    Description: Network Stack Name
    Value: !Ref NetworkStackName

# ==========================================
# ğŸ’¡ ä½¿ç”¨æ–¹æ³•:
# 
# 1. ã¾ãš after-advanced.yaml ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
#    aws cloudformation create-stack \
#      --stack-name myapp-dev-stack \
#      --template-body file://after-advanced.yaml \
#      --parameters ParameterKey=DBPassword,ParameterValue=SecurePass123!
# 
# 2. æ¬¡ã«ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
#    aws cloudformation create-stack \
#      --stack-name myapp-dev-additional \
#      --template-body file://import-example.yaml \
#      --parameters ParameterKey=NetworkStackName,ParameterValue=myapp-dev-stack \
#      --capabilities CAPABILITY_IAM
# 
# âš ï¸ å‰Šé™¤æ™‚ã¯é€†é †:
# 1. ã“ã®ã‚¹ã‚¿ãƒƒã‚¯å‰Šé™¤
#    aws cloudformation delete-stack --stack-name myapp-dev-additional
# 
# 2. å…ƒã®ã‚¹ã‚¿ãƒƒã‚¯å‰Šé™¤
#    aws cloudformation delete-stack --stack-name myapp-dev-stack
# ==========================================
