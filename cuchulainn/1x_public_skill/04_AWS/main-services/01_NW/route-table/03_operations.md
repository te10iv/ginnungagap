# Route Table：運用と実務視点（Lv3）

## 運用で必ず使う機能
- **ルート追加/変更**：メンテナンス時の経路切り替え
- **サブネット関連付け変更**：ルートテーブルの切り替え
- **ルート優先度確認**：最も具体的なCIDRが優先される仕組みの理解

## よくあるトラブル
### トラブル1：インターネット接続できない
- 症状：PublicサブネットのEC2からインターネットに出られない
- 原因：
  - ルートテーブルに 0.0.0.0/0 → IGW のルートがない
  - サブネットに正しいルートテーブルが関連付けられていない
  - メインルートテーブルを使ってしまっている
- 確認ポイント：
  - サブネットに関連付けられているルートテーブルを確認
  - ルートテーブルのルート一覧で 0.0.0.0/0 → igw-xxxxx を確認
  - 明示的な関連付けがない場合はメインルートテーブルが使われる

### トラブル2：VPC Peering で通信できない
- 症状：Peering接続は確立しているのに通信不可
- 原因：
  - 両側のルートテーブルにPeering向けルートがない
  - ルートの宛先CIDRが間違っている
  - Security Groupでブロックされている
- 確認ポイント：
  - 双方のVPCでルートテーブルに相手VPCのCIDR → pcx-xxxxx を追加
  - ルートのターゲットがVPC Peering接続IDか確認

### トラブル3：NAT Gateway経由でインターネット接続できない
- 症状：PrivateサブネットからインターネットアクセスNG
- 原因：
  - ルートテーブルのターゲットがNAT Gatewayになっていない
  - NAT GatewayがPublicサブネットに配置されていない
  - NAT GatewayのElastic IPが割り当てられていない
- 確認ポイント：
  - Privateルートテーブルで 0.0.0.0/0 → nat-xxxxx を確認
  - NAT Gateway の状態が「available」か確認
  - NAT Gateway がPublicサブネット + Elastic IP 持ちか確認

## 監視・ログ
- **VPC Flow Logs**：ルートによる通信の Accept/Reject を記録
- **CloudWatch Metrics**：ルートテーブル専用メトリクスは存在しない
  - NAT Gateway や IGW のメトリクスで間接的に確認
- **ルート変更履歴**：CloudTrailで `CreateRoute`, `DeleteRoute` を記録

## コストでハマりやすい点
- **ルートテーブル自体は無料**：作成・運用に課金なし
- **NAT Gateway経由の通信**：ルートテーブルでNAT Gateway指定すると課金発生
  - 時間課金（$0.062/時間）+ データ処理課金（$0.062/GB）
- **データ転送料**：リージョン間、AZ間の通信は課金
- **VPCエンドポイント活用**：S3/DynamoDBへのルートをエンドポイント経由にしてコスト削減

## 実務Tips
- **メインルートテーブルは使わない**：必ず明示的にルートテーブルを作成して関連付け
- **命名規則**：`{env}-{type}-rt-{az}`（例：prod-public-rt-1a）
- **AZ障害対策**：Multi-AZ構成では各AZのPrivateサブネットに別ルートテーブル
  - AZ-a の Private → NAT Gateway (AZ-a)
  - AZ-c の Private → NAT Gateway (AZ-c)
- **ルート評価順序**：具体的なCIDRが優先（/32 > /24 > /16 > /0）
- **ブラックホールルート**：ターゲットが存在しない場合、通信は破棄される
- **VPCエンドポイント優先**：S3/DynamoDBはゲートウェイ型エンドポイントでコスト削減
- **設計時に言語化すると評価が上がるポイント**：
  - 「Public/Private で明確にルートテーブルを分離」
  - 「Multi-AZ構成では各AZのNAT Gatewayに対応するルートテーブルを設定」
  - 「将来のVPC Peering/TGW接続を考慮したルート設計」
  - 「S3アクセスはVPCエンドポイント経由でコスト・セキュリティ最適化」
