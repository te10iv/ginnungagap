# AWS Client VPN：運用と実務視点（Lv3）

## 運用で必ず使う機能
- **接続ログ監視**：CloudWatch Logsで接続履歴確認
- **クライアント証明書管理**：新規発行・失効
- **認可ルール管理**：ユーザー・グループ別アクセス制御
- **クライアント設定ファイル配布**：新規ユーザー向け

## よくあるトラブル
### トラブル1：VPN接続できない
- 症状：OpenVPNクライアントで接続失敗
- 原因：
  - クライアント証明書の期限切れ
  - クライアント証明書とサーバー証明書の不一致
  - クライアントCIDRブロックの枯渇
  - ファイアウォールでUDP 1194がブロック
- 確認ポイント：
  - クライアント証明書の有効期限確認
  - ACMでサーバー・クライアント証明書確認
  - クライアントCIDRブロックのIP数確認
  - ファイアウォールでUDP 1194許可

### トラブル2：VPN接続後もVPCリソースにアクセスできない
- 症状：VPN接続はできるがEC2/RDS等にアクセス不可
- 原因：
  - 認可ルールが設定されていない
  - ターゲットネットワーク（サブネット）が関連付けられていない
  - Security Groupでクライアント用CIDRがブロック
  - VPCルートテーブルにクライアントCIDR向けルートがない
- 確認ポイント：
  - 認可ルールでVPC CIDR許可確認
  - ターゲットネットワーク関連付け確認
  - Security Groupでクライアント用CIDR許可（例：10.100.0.0/22）
  - VPCルートテーブルでクライアントCIDR → ローカル確認

### トラブル3：接続が頻繁に切断される
- 症状：VPN接続が不安定
- 原因：
  - インターネット回線品質が悪い
  - Keep-Alive設定の問題
  - NAT-Tの問題
- 確認ポイント：
  - CloudWatch Logsで接続履歴確認
  - OpenVPNクライアントログ確認
  - Keep-Alive設定調整

## 監視・ログ
- **CloudWatch Logs**：
  - 接続・切断ログ
  - 認証成功・失敗
  - アクセス先IPアドレス
- **CloudWatch Metrics**：
  - 接続数
  - データ転送量
- **CloudWatch Alarm**：接続数・データ転送量の閾値監視

## コストでハマりやすい点
- **エンドポイント課金**：$0.15/時間（月$108）
- **接続課金**：$0.05/時間/接続
  - 10ユーザー常時接続：月$360
  - 100ユーザー常時接続：月$3,600
- **データ転送料**：アウトバウンド課金
- **削除忘れ**：不要なエンドポイントは削除
- **コスト削減策**：
  - 開発環境は使用時のみ作成
  - スプリットトンネル有効化（VPC向けのみVPN経由）

## 実務Tips
- **証明書管理**：
  - ACMで証明書作成（Easy-RSAで自己署名も可能）
  - クライアント証明書は個別発行（失効管理のため）
- **スプリットトンネル推奨**：インターネット向けは直接接続（帯域節約）
- **Multi-AZ配置**：複数AZのサブネットをターゲットネットワークに設定
- **認可ルール設計**：
  - ユーザーごとまたはグループごとにアクセス範囲を制限
  - 最小権限の原則
- **Active Directory統合**：企業環境では既存ADと統合推奨
- **Security Group設計**：
  - VPC内リソースのSGでクライアントCIDR許可
  - ソースにクライアントCIDR（例：10.100.0.0/22）指定
- **Transit Gateway経由**：複数VPCアクセスが必要な場合はTGW経由
- **CloudWatch Logs有効化必須**：接続ログ・監査証跡
- **クライアント設定ファイル配布**：
  - ダウンロード後、クライアント証明書・秘密鍵を埋め込み
  - メール添付ではなく、セキュアな方法で配布
- **設計時に言語化すると評価が上がるポイント**：
  - 「スプリットトンネル有効化でVPC向けトラフィックのみVPN経由、帯域節約」
  - 「Active Directory統合で既存のユーザー・パスワードで認証、運用簡素化」
  - 「Multi-AZ構成で複数AZのサブネットに配置、冗長性確保」
  - 「認可ルールでユーザー・グループ別にアクセス制御、最小権限の原則」
  - 「CloudWatch Logs有効化で接続履歴・監査証跡を記録」
  - 「Transit Gateway経由で複数VPCへのアクセスを集約」

## Client VPN vs Site-to-Site VPN

| 項目 | Client VPN | Site-to-Site VPN |
|------|------------|------------------|
| 用途 | 個人ユーザー→VPC | 拠点（オンプレ）→VPC |
| 接続元 | PCやモバイル | VPNルーター |
| 認証 | 証明書/AD/Cognito | 事前共有鍵（PSK） |
| プロトコル | OpenVPN | IPsec |
| コスト | $0.15/h + $0.05/h/接続 | $0.05/h |
| 用途例 | リモートワーク | ハイブリッドクラウド |
