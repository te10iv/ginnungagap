# AWS Global Accelerator：運用と実務視点（Lv3）

## 運用で必ず使う機能
- **トラフィックダイアル**：リージョン間トラフィック割合調整（0%〜100%）
- **エンドポイント重み付け**：同一リージョン内の複数エンドポイント間でトラフィック配分
- **ヘルスチェック**：エンドポイント監視、自動フェイルオーバー
- **Flow Logs**：トラフィックログをS3保存

## よくあるトラブル
### トラブル1：固定IPでアクセスできない
- 症状：Global Acceleratorの固定IPにアクセスできない
- 原因：
  - エンドポイント（ALB/NLB）が停止・削除
  - エンドポイントのヘルスチェックが失敗
  - Security Groupでアクセスがブロック
  - トラフィックダイアルが0%
- 確認ポイント：
  - エンドポイントの状態確認（healthy）
  - ヘルスチェック設定確認
  - トラフィックダイアル確認（100%）
  - Security Groupで固定IP許可

### トラブル2：ヘルスチェックが失敗し続ける
- 症状：エンドポイントのヘルスステータスがunhealthy
- 原因：
  - ヘルスチェックパスが存在しない（404エラー）
  - Security Groupでヘルスチェックがブロック
  - ヘルスチェック間隔・閾値が厳しすぎる
- 確認ポイント：
  - ヘルスチェックパス確認（/health, / 等）
  - Security GroupでGlobal Acceleratorからの通信許可
  - ヘルスチェック設定調整（interval, threshold）

### トラブル3：期待したリージョンに接続されない
- 症状：ユーザーが意図しないリージョンに接続される
- 原因：
  - Anycast IPは地理的に最適なエッジに接続（制御不可）
  - トラフィックダイアルの設定ミス
  - エンドポイント重みの設定ミス
- 確認ポイント：
  - トラフィックダイアル確認（リージョン単位）
  - エンドポイント重み確認（同一リージョン内）
  - CloudWatch Logsでアクセス元・接続先確認

## 監視・ログ
- **CloudWatch Metrics**：
  - `NewFlowCount`：新規フロー数
  - `ProcessedBytesIn / Out`：処理バイト数
- **Flow Logs**：S3バケットに保存
  - クライアントIP、エンドポイント、プロトコル
  - Athenaでクエリ分析可能
- **CloudWatch Alarm**：ヘルスチェック失敗、フロー数閾値

## コストでハマりやすい点
- **Accelerator課金**：$0.025/時間（月$18）
- **データ転送料**：$0.015/GB（Global Accelerator経由）
  - CloudFrontより高い（CloudFront: $0.085〜/GB）
- **削除忘れ**：使っていないAcceleratorは削除（月$18の無駄）
- **コスト削減策**：
  - 開発環境は使用時のみ作成
  - CloudFrontとの使い分け（静的コンテンツはCloudFront）

## 実務Tips
- **固定IP必須時に活用**：ホワイトリスト登録、ファイアウォールルール
- **CloudFrontとの使い分け**：
  - **CloudFront**：キャッシュ、静的コンテンツ、HTTP/HTTPS
  - **Global Accelerator**：動的コンテンツ、TCP/UDP、固定IP
- **マルチリージョンDR構成**：
  - プライマリリージョン：トラフィックダイアル100%
  - セカンダリリージョン：トラフィックダイアル0%（障害時100%）
- **ヘルスチェック設計**：
  - Interval：30秒（デフォルト）
  - Threshold：3回連続失敗でunhealthy
- **トラフィックダイアル**：リージョンごとにトラフィック割合調整（Blue/Greenデプロイ）
- **エンドポイント重み**：同一リージョン内の複数エンドポイント間で負荷分散
- **Shield Advanced統合**：DDoS対策強化、追加料金あり
- **Flow Logs有効化推奨**：アクセス分析、異常検知
- **設計時に言語化すると評価が上がるポイント**：
  - 「Anycast IPで世界中からのアクセスを最寄りエッジに誘導、低レイテンシー」
  - 「AWSグローバルネットワーク経由でインターネット品質依存を排除」
  - 「マルチリージョン構成でDR対応、トラフィックダイアルで切り替え」
  - 「固定IP要件に対応、ホワイトリスト登録・ファイアウォールルール設定」
  - 「ヘルスチェックで自動フェイルオーバー、可用性確保」
  - 「TCP/UDP全プロトコル対応、ゲームサーバー・VoIPに最適」

## Global Accelerator vs CloudFront

| 項目 | Global Accelerator | CloudFront |
|------|-------------------|------------|
| 用途 | 動的コンテンツ、TCP/UDP | 静的コンテンツ、HTTP/HTTPS |
| キャッシュ | なし | あり |
| プロトコル | TCP/UDP全対応 | HTTP/HTTPS/WebSocket |
| 固定IP | あり（Anycast IP×2） | なし |
| レイテンシー | 低い（AWSネットワーク） | 低い（エッジキャッシュ） |
| コスト | $0.025/h + $0.015/GB | データ転送料のみ |
| 用途例 | ゲーム、VoIP、動的API | 画像・動画配信、静的サイト |
| DDoS対策 | Shield統合 | Shield統合 + WAF |
