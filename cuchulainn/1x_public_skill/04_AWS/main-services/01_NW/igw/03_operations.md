# Internet Gateway (IGW)：運用と実務視点（Lv3）

## 運用で必ず使う機能
- **アタッチ/デタッチ**：VPCのマイグレーションやメンテナンス時
- **ルートテーブル確認**：IGWへのルート設定の確認
- **VPC Flow Logs**：IGW経由の通信ログを記録（セキュリティ分析）

## よくあるトラブル
### トラブル1：EC2からインターネット接続できない
- 症状：パブリックIPを持つEC2からcurlやpingが通らない
- 原因：
  - IGWがVPCにアタッチされていない
  - ルートテーブルに 0.0.0.0/0 → IGW のルートがない
  - サブネットに正しいルートテーブルが関連付けられていない
  - Security Groupでアウトバウンドがブロックされている
- 確認ポイント：
  - VPCにIGWがアタッチされているか確認
  - ルートテーブルの確認（0.0.0.0/0 → igw-xxxxx）
  - サブネットとルートテーブルの関連付け確認
  - Security Groupのアウトバウンドルール確認

### トラブル2：IGWを削除できない
- 症状：「依存リソースが存在します」エラー
- 原因：
  - IGWがまだVPCにアタッチされている
  - Elastic IPがIGW経由で使用されている
- 確認ポイント：
  - まずVPCからデタッチ
  - Elastic IPの関連付けを解除
  - その後削除

### トラブル3：インターネットから EC2 にアクセスできない
- 症状：外部からパブリックIPでSSH/HTTP接続できない
- 原因：
  - EC2にパブリックIPが割り当てられていない
  - Security Groupでインバウンドがブロックされている
  - Network ACLでブロックされている
- 確認ポイント：
  - EC2にパブリックIPが存在するか
  - Security Groupのインバウンドルール（ソースIP確認）
  - Network ACLの設定（通常は全許可）

## 監視・ログ
- **VPC Flow Logs**：IGW経由の通信を記録
  - ENI単位・サブネット単位・VPC単位で有効化
  - Accept/Reject のフロー記録
- **CloudWatch Metrics**：IGW専用のメトリクスは存在しない
  - NAT Gateway や EC2 のメトリクスで間接的に確認
- **データ転送量**：CloudWatchで送信バイト数を監視

## コストでハマりやすい点
- **IGW自体は無料**：作成・稼働に課金なし
- **データ転送料**：
  - インターネットへの送信（アウトバウンド）は課金（$0.114/GB〜）
  - インターネットからの受信（インバウンド）は無料
  - リージョン間通信も課金対象
- **Elastic IP**：IGWを使う場合でも、未使用Elastic IPは課金
- **NAT Gateway**：Private→IGW経由の通信はNAT Gateway課金が発生

## 実務Tips
- **IGWは1VPCに1つだけ**：複数必要な場合はVPCを分ける
- **削除手順**：デタッチ → 削除（アタッチ済みは削除不可）
- **IPv6対応**：Egress-Only Internet Gatewayを別途作成（アウトバウンドのみ許可）
- **Direct Connect併用時**：オンプレ向けはDirect Connect、インターネット向けはIGW
- **セキュリティ設計**：IGWは全通信可能なので、Security Group/NACLで制御必須
- **タグ付け**：環境・プロジェクトのタグを必ず付与
- **設計時に言語化すると評価が上がるポイント**：
  - 「IGWはAWS管理のため冗長化・スケーリング不要」
  - 「Public SubnetからのインターネットアクセスはIGW経由」
  - 「Private SubnetはNAT Gateway → IGW の2段階でインターネット接続」
  - 「データ転送コスト削減のため、VPCエンドポイント利用を検討」
