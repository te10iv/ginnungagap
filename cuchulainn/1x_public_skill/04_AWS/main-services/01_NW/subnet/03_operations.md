# Subnet：運用と実務視点（Lv3）

## 運用で必ず使う機能
- **サブネットグループ**：RDS・ElastiCacheで使用（複数サブネット指定）
- **ルートテーブルの切り替え**：メンテナンス時に通信経路を変更
- **IPアドレス管理**：利用可能IP数の監視

## よくあるトラブル
### トラブル1：EC2にパブリックIPが割り当てられない
- 症状：Publicサブネットなのにパブリックアクセスできない
- 原因：
  - サブネットの「自動割り当てパブリックIP」が無効
  - 起動時にパブリックIP割り当てを指定していない
- 確認ポイント：
  - サブネット設定で「パブリックIPの自動割り当て」を確認
  - EC2起動時の設定を確認

### トラブル2：RDS作成時にサブネットエラー
- 症状：「DBサブネットグループが最低2つのAZをカバーしていない」エラー
- 原因：DBサブネットグループに異なるAZのサブネットが含まれていない
- 確認ポイント：
  - DBサブネットグループに最低2つの異なるAZのサブネットがあるか
  - サブネットが全てPrivateになっているか

### トラブル3：IPアドレス不足
- 症状：新しいEC2やENIが起動できない
- 原因：サブネットのCIDRが小さすぎる（/28だと11個しか使えない）
- 確認ポイント：
  - サブネットの利用可能IP数を確認（AWS予約5個を考慮）
  - 新しいサブネットの追加を検討

## 監視・ログ
- **VPC Flow Logs**：サブネット単位で有効化可能
- **CloudWatch Metrics**：サブネット固有のメトリクスは存在しない
- **利用可能IP数**：
  - マネコンで「利用可能なIPv4アドレス」を確認
  - /24 = 256個 - 5個（AWS予約）= 251個

## コストでハマりやすい点
- **NAT Gateway**：PublicサブネットごとにNAT Gatewayを配置すると高額
  - Multi-AZなら最低2つ必要（月$64〜）
  - シングルNAT構成も検討（可用性とコストのトレードオフ）
- **Elastic IP**：NAT Gateway用に確保（未使用だと課金）
- **不要なサブネット**：使っていないサブネットは削除（直接課金はないが構成が複雑に）

## 実務Tips
- **命名規則を統一**：`{env}-{role}-subnet-{az}`（例：prod-public-subnet-1a）
- **CIDR設計**：AZ数 × 用途で事前に計算（例：2AZ × 3層 = 6サブネット）
- **AZ指定は明示的に**：Terraformでは必ずAZを明示（自動割り当ては避ける）
- **Public SubnetはCIDR範囲を小さく**：ALB・NAT Gateway程度なら/28で十分
- **Private Subnetは広めに**：EC2・RDS・Lambda ENIを考慮して/24推奨
- **タグ付け**：`kubernetes.io/role/elb=1`（EKS用）など特定タグが必要な場合も
- **設計時に言語化すると評価が上がるポイント**：
  - 「Multi-AZ構成で各AZに Public/Private サブネットを配置」
  - 「Public は ALB 用に /28、Private は App/DB 用に /24 で設計」
  - 「将来の拡張を考慮し、サブネットCIDRに余裕を持たせています」
  - 「RDS は Multi-AZ 配置のため、異なる AZ の Private サブネット2つを指定」
