# AWS Direct Connect：運用と実務視点（Lv3）

## 運用で必ず使う機能
- **BGPセッション監視**：BGP状態確認、経路広告確認
- **CloudWatch Metrics**：データ転送量、接続状態
- **メンテナンス通知**：AWSからのメンテナンス通知対応
- **帯域監視**：帯域使用率、ピーク時の帯域確保

## よくあるトラブル
### トラブル1：Direct Connect接続が確立しない
- 症状：BGPセッションがUPしない
- 原因：
  - オンプレ側ルーターのBGP設定ミス
  - VLAN IDの不一致
  - MD5認証の設定ミス
  - ASN（AS Number）の設定ミス
- 確認ポイント：
  - DXコンソールで接続状態確認（available）
  - BGP セッション状態確認（UP）
  - オンプレ側ルーターでBGP neighbor確認
  - VLAN ID、MD5パスワード、ASN確認

### トラブル2：VPC間通信できない
- 症状：DX接続は確立しているがオンプレ↔VPC通信不可
- 原因：
  - VPC側ルートテーブルにオンプレ向けルートがない
  - オンプレ側ルーターにVPC向けルートがない
  - Security Group / NACLでブロック
  - BGP広告が正しくない
- 確認ポイント：
  - VGW/TGWでBGP経路受信確認
  - VPCルートテーブルでオンプレCIDR → VGW/TGW確認
  - オンプレ側ルーターでVPC CIDR受信確認
  - Security Group・NACLの設定確認

### トラブル3：帯域不足・パケットロス
- 症状：DX経由の通信が遅い、パケットロス発生
- 原因：
  - 契約帯域を超過
  - 帯域設計不足
  - MTUサイズ不一致
- 確認ポイント：
  - CloudWatchで帯域使用率確認
  - 契約帯域とピーク帯域の比較
  - MTUサイズ確認（最大9001、ジャンボフレーム）

## 監視・ログ
- **CloudWatch Metrics**：
  - `ConnectionState`：接続状態（1=UP, 0=DOWN）
  - `ConnectionBpsEgress / Ingress`：データ転送速度
  - `ConnectionPpsEgress / Ingress`：パケット数/秒
  - `ConnectionLightLevelTx / Rx`：光レベル（物理層）
- **BGPセッション監視**：BGP Neighbor状態、経路数
- **CloudWatch Alarm**：接続断、帯域閾値超過

## コストでハマりやすい点
- **ポート時間課金**：
  - 1Gbps: $0.30/時間（月$216）
  - 10Gbps: $2.25/時間（月$1,620）
  - 100Gbps: $22.50/時間（月$16,200）
- **データ転送料（アウトバウンド）**：
  - $0.025/GB（東京リージョン）
  - インバウンドは無料
- **初期費用**：
  - 専用接続：$0（ポート時間課金のみ）
  - ホスト接続：パートナーによる
  - 物理配線工事費：別途（数十万〜数百万円）
- **削除時の注意**：解約手続き必要、最低利用期間あり（契約による）
- **コスト削減策**：
  - ホスト接続で小規模開始
  - 帯域を適切にサイジング（過剰契約を避ける）
  - 開発環境はVPN使用

## 実務Tips
- **冗長構成必須**：本番環境は必ずDual DX or DX + VPN
- **リードタイム**：物理配線に1〜数ヶ月、計画的に発注
- **ロケーション選定**：オンプレから近いロケーション選択
- **パートナー活用**：ホスト接続はDirect Connectパートナー経由が簡単
- **帯域設計**：ピーク時 + 30%の余裕を持たせる
- **BGP設計**：
  - AS-PATH Prepend で優先経路制御
  - MED（Multi-Exit Discriminator）で経路制御
- **MTU設定**：ジャンボフレーム（9001）で効率化
- **MACsec暗号化**：セキュリティ要件が高い場合に有効化
- **メンテナンス対応**：定期メンテナンス通知に対応、冗長構成なら影響なし
- **Site-to-Site VPN併用**：
  - DXがプライマリ（低コスト・高帯域）
  - VPNがセカンダリ（バックアップ）
- **設計時に言語化すると評価が上がるポイント**：
  - 「Dual DX構成で異なるロケーションから接続、ロケーション障害に対応」
  - 「DX + VPN ハイブリッド構成で冗長性とコストを両立」
  - 「Transit Gateway + DX Gateway で複数VPC・マルチリージョン接続を集約」
  - 「帯域設計はピーク時 + 30% で余裕を確保、将来の拡張も考慮」
  - 「MACsec暗号化で通信セキュリティを強化」
  - 「BGPで経路制御、AS-PATH Prepend でプライマリ・セカンダリを明示的に設定」

## Direct Connect vs Site-to-Site VPN

| 項目 | Direct Connect | Site-to-Site VPN |
|------|----------------|------------------|
| 接続方式 | 専用線 | インターネット経由 |
| 帯域 | 50Mbps〜100Gbps | 最大1.25Gbps |
| レイテンシー | 低い（安定） | 高い（変動） |
| コスト | 高額（月数万〜） | 低額（$0.05/h） |
| リードタイム | 1〜数ヶ月 | 即日 |
| 用途 | 本番・大容量 | 開発・バックアップ |
| 冗長性 | Dual DX or DX+VPN | マルチVPN |
