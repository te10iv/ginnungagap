

# 要するに
以下の構成図が正しい

![[Pasted image 20251129000545.png]]


## 説明
- VPC
	- AWS内に作る自分専用のネットワーク空間。
- InternetGateway（IGW）
	- VPC をインターネットに接続するための玄関。
		- 無料
		- VPC内のリソースは一部例外（Direct Connect 、VPN）を除き、こいつを経由しないとインターネットに出られない
			- Public Subnet のルートテーブルで IGW がデフォルトルート（0.0.0.0/0）になる
			- VPC、サブネット は CIDRは/16〜/28の範囲でしか作れない
- PublicSubnet
	- Internet Gateway 経由でインターネットと通信できるサブネット。  
	- 外部からアクセスされる可能性がある場所。
- PrivateSubnet
	- Internet Gateway を直接使えず、外部からアクセスできないサブネット。
		- Private Subnet → NAT Gateway → Internet Gateway → Internet という経路で外へ出る
	- 内部処理用サーバ（＝外部公開しないサーバ）を安全に置く場所。
- ALB
	- 各サーバへのリクエストを分散させる（１つのサーバばかりに処理が集中しないようにする）
		- Webサーバであれば、WebサーバへのHTTP/HTTPSリクエストを複数WEBサーバへ振り分ける入り口。
- NAT Gateway（NATGW）
	- PrivateSubnetにいるサーバが、『外には出られるが絶対に外からは見えない』状態でインターネットへ接続するための出口。
	- 有料
		- （$0.062/時間 + 通信料）($3.x/月 + 通信料)
	- Private サブネットは IGW を直接使えないというAWSの仕様のため、NAT GW を経由する必要がある（セキュリティ確保のためAWSがそういう仕様にしている）
	- 一般的には、PrivateSubnet内の端末やIPがインターネットに出たいときは、こいつを経由して、さらにInternetGatewayを経由して外に出ていかないといけない（それが、AWSの決まり）



# AWS 内部の予約 IP ルール

- **サブネット内**の上位 4つの IP は予約されており、割り当て不可：

| 種類                     | 例（10.0.1.0/24） | 説明                                     |
| ---------------------- | -------------- | -------------------------------------- |
| Network address        | 10.0.1.0       | ネットワーク識別子                              |
| **VPC Router（DGW）**    | **10.0.1.1**   | デフォルトゲートウェイ                            |
| AWS が予約（＝別リソースで利用できない） | 10.0.1.2       | AmazonProvidedDNS 用の仮想IP　＝DNS への転送ポイント |
| AWS が予約（＝別リソースで利用できない） | 10.0.1.3       | 将来用（現状は特に用途なし）                         |
| Broadcast（未使用でも予約扱い）   | 10.0.1.255     | ブロードキャスト                               |

- 応用問題
	- 10.0.1.128/25だとどうなりますか？

- 【誤解しないように】VPC内**の上位 4つ、じゃないので、勘違いしないように。
	- PublicSubnetA 10.1.0.0/24なら、10.1.0.1/24は、VPCルータのIPアドレス。PrivateSubnetA 10.2.0.0/24なら、10.2.0.1/24が、VPCルータのIPアドレス。


- サブネットの.2　についての補足　（＝　AmazonProvidedDNS 用の仮想IP　＝DNS への転送ポイント　についての補足）
	- 公式資料には**AmazonProvidedDNS は “VPC_CIDR の .2” で提供される**と書かれている。
	- しかし実際のDNSサーバの実体は別の場所にある（仮想的に見せているだけ））
	- VPC 内の「サブネット内の」 .2（AmazonProvidedDNS の仮想 IP）宛の DNS クエリは、  VPC ルーター（.1）が受け取り、裏側の AmazonProvidedDNS（VPC外にある実体）に転送してくれる。

# 重要ポイント

- **IGW や NATGW の IPではない**
    
- **ALB の IPでもない**
    
- **各サブネット内の .1 が必ず DGW（VPC Router）**
    

インスタンスは常に **.1** を最初のルーターとして通信する。




# 読み物：　AWS にL2ブロードキャストがない理由

- 答え
	- AWS の VPC は “L2（レイヤ2）を持たないためARP ブロードキャストが流れず、すべてVPCルータ（.1）が直接通信を受けて、 L3通信(ProxyARP)として宛先に応答（IPルーティング）するという構成だから。
		- **AWS は ARP を禁止し、代わりに L3 レベルの“プロキシARP”を使う**
			- EC2 は ARP を送っても「本来の L2 ARP ブロードキャスト」にはならず、**VPC ルーター (.1) が ARP を吸い取って答えている（Proxy ARP）**
			- つまり。
				- EC2 → ARPリクエスト送る
				- 一般的なオンプレNWはL2スイッチがいるためブロードキャストになるが、AWSでは**VPC ルーター (.1) が ARP リクエストを必ず受け取り、Proxy ARP（L3） として応答するため、AWS 内部ではブロードキャスト化せず、**VPCルーターが単独で応答している**
			- 結果として
				- **ARP ブロードキャストは存在しない**    
				- **ARP の応答はすべて VPC ルーターが担当する**
				- **同一サブネット内でも L2 のやり取りは起きない（全部 L3）**
			- これにより **L2ブロードキャストが発生しようが発生しないように処理される**。








