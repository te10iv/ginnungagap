# Site-to-Site VPN：運用と実務視点（Lv3）

## 運用で必ず使う機能
- **VPNトンネル状態監視**：UP/DOWN確認
- **設定ファイルダウンロード**：オンプレ側ルーター設定用
- **静的ルート vs BGP**：経路制御方式の選択
- **トンネル再起動**：障害時のリカバリ

## よくあるトラブル
### トラブル1：VPNトンネルがUPしない
- 症状：VPN Connection作成後もトンネル状態がDOWN
- 原因：
  - オンプレ側ルーターのIPsec設定ミス
  - 事前共有鍵（PSK）の不一致
  - ファイアウォールでIPsec通信（UDP 500, 4500）がブロック
  - オンプレ側ルーターのパブリックIPが間違っている
- 確認ポイント：
  - VPNコンソールでトンネル状態確認（UP/DOWN）
  - 設定ファイルをダウンロードし、オンプレ側設定と比較
  - ファイアウォールでUDP 500, 4500許可
  - CGWのIPアドレス確認

### トラブル2：VPN接続確立後も通信できない
- 症状：トンネルはUPだがオンプレ↔VPC通信不可
- 原因：
  - VPC側ルートテーブルにオンプレ向けルートがない
  - オンプレ側ルーターにVPC向けルートがない
  - Security Group / NACLでブロック
  - BGP経路広告の問題
- 確認ポイント：
  - VPCルートテーブルでオンプレCIDR → VGW/TGW確認
  - オンプレ側ルーターでVPC CIDR向けルート確認
  - BGP使用時は経路受信確認（show ip bgp neighbors）
  - Security Group・NACLの設定確認

### トラブル3：VPN接続が不安定（頻繁にDOWN）
- 症状：VPNトンネルが頻繁に切断・再接続
- 原因：
  - インターネット回線品質が悪い
  - オンプレ側ルーターのDPD（Dead Peer Detection）設定
  - MTUサイズ不一致
  - NAT-T（UDP 4500）の問題
- 確認ポイント：
  - CloudWatchでトンネル状態履歴確認
  - オンプレ側ルーターのログ確認
  - DPD設定調整（タイムアウト・リトライ）
  - MTUサイズ確認（推奨: 1400以下）

## 監視・ログ
- **CloudWatch Metrics**：
  - `TunnelState`：トンネル状態（1=UP, 0=DOWN）
  - `TunnelDataIn / TunnelDataOut`：データ転送量
- **VPN接続ログ**：トンネル状態変化、IPsecフェーズ1/2
- **CloudWatch Alarm**：トンネルDOWN時にSNS通知

## コストでハマりやすい点
- **VPN Connection課金**：$0.05/時間（月$36/Connection）
- **データ転送料（アウトバウンド）**：$0.09/GB（リージョンによる）
  - インバウンドは無料
- **複数VPN Connection**：冗長化で2本作成すると月$72
- **Accelerated VPN**：追加料金あり（Global Accelerator使用）
- **削除忘れ**：使っていないVPN Connectionは削除
- **コスト削減策**：
  - 開発環境は使用時のみ作成
  - 不要なVPN Connectionは削除

## 実務Tips
- **BGP推奨**：動的経路制御でフェイルオーバー自動化
- **冗長構成**：
  - デフォルトで2トンネル（異なるAWS側エンドポイント）
  - さらにオンプレ側も2台のルーターで4トンネル構成可能
- **設定ファイル活用**：オンプレ側ルーター設定はダウンロード可能（主要ベンダー対応）
- **MTU設定**：1400以下推奨（IPsecオーバーヘッド考慮）
- **DPD設定**：オンプレ側ルーターのDPDタイムアウト調整
- **静的ルート vs BGP**：
  - **静的ルート**：シンプル、固定経路
  - **BGP**：動的、フェイルオーバー自動、推奨
- **Accelerated VPN**：Global Accelerator使用で高速化・安定化（追加料金）
- **Direct Connectとの併用**：
  - DXがプライマリ（低レイテンシー・高帯域）
  - VPNがセカンダリ（バックアップ）
- **Transit Gatewayとの組み合わせ**：複数VPC接続時はTGW経由推奨
- **設計時に言語化すると評価が上がるポイント**：
  - 「デフォルトの2トンネル冗長構成で、AWS側の障害に対応」
  - 「BGP使用で動的経路制御、トンネル障害時は自動フェイルオーバー」
  - 「Direct Connect + VPN ハイブリッド構成で冗長性とコストを両立」
  - 「Transit Gateway経由で複数VPC・マルチリージョン接続を集約」
  - 「MTU 1400設定でIPsecフラグメント回避、通信安定化」
  - 「Accelerated VPN使用でグローバルネットワーク経由、レイテンシー・安定性を改善」

## Site-to-Site VPN vs Direct Connect

| 項目 | Site-to-Site VPN | Direct Connect |
|------|------------------|----------------|
| 接続方式 | インターネット経由（IPsec） | 専用線 |
| 帯域 | 最大1.25Gbps/トンネル | 50Mbps〜100Gbps |
| レイテンシー | 高い（変動） | 低い（安定） |
| コスト | 低額（$0.05/h） | 高額（月数万〜） |
| リードタイム | 即日 | 1〜数ヶ月 |
| 冗長性 | デフォルト2トンネル | Dual DX or DX+VPN |
| 用途 | 開発・バックアップ・低コスト | 本番・大容量・低レイテンシー |
