# AWS Transit Gateway：運用と実務視点（Lv3）

## 運用で必ず使う機能
- **アタッチメント追加/削除**：新規VPCの追加、不要VPCの削除
- **ルートテーブル管理**：TGW側・VPC側のルート追加/削除
- **Network Manager**：グローバルネットワークの可視化・管理
- **Flow Logs**：TGW経由トラフィックのログ記録

## よくあるトラブル
### トラブル1：VPC間で通信できない
- 症状：TGWアタッチメントは作成済みだが通信不可
- 原因：
  - VPC側ルートテーブルにTGW向けルートがない
  - TGWルートテーブルにルートがない（デフォルト伝播無効時）
  - Security Groupで通信がブロック
  - Network ACLで通信がブロック
- 確認ポイント：
  - 送信元VPCのルートテーブルで宛先CIDR → TGW確認
  - 宛先VPCのルートテーブルで送信元CIDR → TGW確認
  - TGWルートテーブルで双方向ルート確認
  - Security Group・NACLの設定確認

### トラブル2：オンプレとVPC間で通信できない
- 症状：Direct Connect/VPN経由でオンプレとVPC間通信不可
- 原因：
  - TGWにDX Gateway/VPN アタッチメントがない
  - オンプレ向けルートがVPCルートテーブルにない
  - VPC向けルートがオンプレ側ルーターにない
  - BGP設定ミス
- 確認ポイント：
  - TGWにDX/VPNアタッチメント存在確認
  - VPCルートテーブルでオンプレCIDR → TGW確認
  - TGWルートテーブルでオンプレ向けルート確認
  - オンプレ側ルーターでVPC向けルート確認

### トラブル3：予想外の高額課金
- 症状：月末にTGW課金が数万円
- 原因：
  - TGW時間課金（$0.05/h → 月$36）
  - データ処理料（$0.02/GB）が大量
  - 不要なVPCがアタッチされたまま
- 確認ポイント：
  - Cost ExplorerでTGWフィルタ
  - データ処理量をCloudWatchで確認
  - 不要なアタッチメント削除
  - VPCエンドポイント活用で同一リージョン内AWS通信を削減

## 監視・ログ
- **CloudWatch Metrics**：
  - `BytesIn / BytesOut`：TGW経由データ転送量
  - `PacketDropCount`：パケット破棄数
  - `BytesDropCount`：破棄バイト数
- **VPC Flow Logs**：TGW ENI経由の通信ログ
- **Network Manager**：グローバルネットワークの可視化・監視
- **CloudWatch Alarm**：データ転送量・パケット破棄の閾値監視

## コストでハマりやすい点
- **TGW時間課金**：$0.05/時間（月$36）
- **データ処理料**：$0.02/GB（TGW経由の全データ）
  - VPC間通信・オンプレ通信すべて課金
  - 大規模環境では月数千〜数万ドル
- **VPC Peeringとの比較**：
  - Peering：データ転送料のみ（$0.01/GB、リージョン内）
  - TGW：時間課金 + データ処理料（$0.02/GB）
  - 2〜3 VPCならPeeringが安い、4つ以上ならTGWが管理しやすい
- **コスト削減策**：
  - 不要なアタッチメント削除
  - VPCエンドポイント活用（S3/DynamoDB）
  - データ転送量の多いVPC間はPeering併用検討

## 実務Tips
- **VPC Peeringとの使い分け**：
  - **Peering**：2〜3 VPC、低コスト、フルメッシュ管理
  - **TGW**：4つ以上、オンプレ接続、集中管理
- **アタッチメントサブネット**：各AZに1つずつPrivateサブネット指定
- **ルートテーブル設計**：
  - デフォルト伝播（enable）：自動でルート追加
  - カスタムルートテーブル：セグメント分離
- **セグメント分離**：
  - 本番環境用TGWルートテーブル
  - 開発環境用TGWルートテーブル
  - 環境間通信を制限
- **Appliance Mode**：ファイアウォール経由で全トラフィック検査
- **マルチアカウント共有**：RAMでTGWを共有、各アカウントで個別にアタッチメント作成
- **TGW Peering**：リージョン間接続、グローバル展開
- **Network Manager**：複数リージョン・アカウントのTGWを統合管理
- **設計時に言語化すると評価が上がるポイント**：
  - 「Hub-Spoke構成で複数VPCを中央管理、ルーティング設計を簡素化」
  - 「Direct Connect Gateway経由でオンプレと全VPCを接続」
  - 「TGWルートテーブルでセグメント分離、本番/開発環境の通信を制限」
  - 「RAMでマルチアカウント共有、各アカウントで個別にVPCアタッチメント作成」
  - 「TGW Peeringでリージョン間接続、グローバルネットワークを構築」
  - 「Appliance Modeで全トラフィックをNetwork Firewall経由、セキュリティ強化」

## VPC Peering vs Transit Gateway

| 項目 | VPC Peering | Transit Gateway |
|------|-------------|-----------------|
| 接続数 | 2VPC（1:1） | 数千VPC |
| 管理 | フルメッシュ（N*(N-1)/2本） | 中央ハブ |
| オンプレ接続 | 不可 | 可能（DX/VPN） |
| ルーティング | 推移的不可 | 中央制御 |
| コスト | データ転送のみ | 時間課金 + データ処理 |
| 用途 | 2〜3 VPC | 4つ以上、オンプレ接続 |
