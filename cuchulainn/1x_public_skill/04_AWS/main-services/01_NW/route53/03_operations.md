# Amazon Route 53：運用と実務視点（Lv3）

## 運用で必ず使う機能
- **レコード変更**：ALB/CloudFront の切り替え、IP変更
- **TTL調整**：切り替え前にTTLを短く（60秒）、切り替え後に長く（300〜3600秒）
- **ヘルスチェック**：エンドポイント監視、フェイルオーバー自動化
- **トラフィックフロー**：複雑なルーティングポリシーの可視化

## よくあるトラブル
### トラブル1：ドメインにアクセスできない
- 症状：ブラウザで「DNS_PROBE_FINISHED_NXDOMAIN」エラー
- 原因：
  - ネームサーバーがドメインレジストラに設定されていない
  - ネームサーバーの設定ミス（4つ全て設定必要）
  - レコードが存在しない
  - TTLが長く、変更が反映されていない
- 確認ポイント：
  - ドメインレジストラでネームサーバー設定確認
  - `dig example.com NS` でネームサーバー確認
  - Route 53ホストゾーンでレコード確認
  - `dig example.com` でDNS解決確認

### トラブル2：ALBに接続できない
- 症状：DNSは解決するがALBに接続できない
- 原因：
  - エイリアスレコードのターゲットALBが間違っている
  - ALB自体が停止・削除されている
  - Security GroupでHTTP/HTTPS がブロックされている
- 確認ポイント：
  - エイリアスレコードのALB DNS名確認
  - ALBの状態確認（active）
  - Security Groupの設定確認

### トラブル3：DNS切り替え後も古いIPに接続される
- 症状：レコード変更したのに古いIPにアクセスされる
- 原因：DNSキャッシュ（TTL期間中はキャッシュが残る）
- 確認ポイント：
  - TTLを確認（長いと反映に時間がかかる）
  - 切り替え前にTTLを短く設定（60秒）
  - `dig example.com` で最新のDNS応答確認
  - ブラウザのDNSキャッシュクリア

## 監視・ログ
- **Query Logging**：DNSクエリログをCloudWatch Logsに記録
  - どのドメインが何回クエリされたか
  - DDoS攻撃の検知
- **CloudWatch Metrics**：
  - ヘルスチェックの成功/失敗
  - クエリ数（課金対象）
- **CloudTrail**：レコード作成/変更/削除の履歴

## コストでハマりやすい点
- **ホストゾーン**：$0.50/月/ゾーン
- **標準クエリ**：$0.40/100万クエリ（最初の10億クエリ）
- **エイリアスレコード**：AWSリソース向けは無料（推奨）
- **ヘルスチェック**：$0.50/月/チェック
- **トラフィックフロー**：$50/月/ポリシーレコード
- **クエリ数増加**：人気サイトは月数万〜数十万クエリ
- **不要なホストゾーン削除**：使っていないゾーンは削除

## 実務Tips
- **エイリアスレコード優先**：AWSリソース向けは必ずエイリアス（無料）
- **TTL設定**：通常は300〜3600秒、切り替え時は60秒
- **Apex（ルート）ドメイン**：example.com はエイリアスレコード使用（CNAMEは不可）
- **www有無の統一**：wwwありなしを301リダイレクトで統一
- **ヘルスチェック活用**：フェイルオーバー構成で自動切り替え
- **プライベートホストゾーン**：VPC内のプライベートDNS管理
- **DNSSEC**：セキュリティ要件が高い場合に有効化
- **複数環境の管理**：
  - dev.example.com → 開発環境
  - staging.example.com → ステージング環境
  - www.example.com → 本番環境
- **ACM証明書の自動更新**：DNS検証でRoute 53レコード自動追加
- **設計時に言語化すると評価が上がるポイント**：
  - 「エイリアスレコードでALBを設定し、クエリ課金を無料化」
  - 「TTLは通常300秒、メンテナンス時は60秒に短縮して迅速な切り替え」
  - 「フェイルオーバー構成でプライマリ/セカンダリリージョンを設定」
  - 「レイテンシールーティングでグローバルユーザーに最適なリージョンを自動選択」
  - 「ヘルスチェックでエンドポイント監視、障害時は自動的にセカンダリに切り替え」
