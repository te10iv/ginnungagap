# Amazon RDS：運用と実務視点（Lv3）

## 運用で必ず使う機能
- **スナップショット作成**：手動バックアップ
- **ポイントインタイムリカバリ**：任意の時点に復元
- **パラメータグループ変更**：DB設定変更
- **インスタンスタイプ変更**：スペック変更（再起動必要）

## よくあるトラブル
### トラブル1：EC2からRDSに接続できない
- 症状：「Connection timed out」エラー
- 原因：
  - Security Groupで接続元が許可されていない
  - RDSがPublicアクセス無効（意図通り）
  - エンドポイントが間違っている
- 確認ポイント：
  - RDSのSecurity GroupでEC2のSGまたはIPを許可
  - ポート確認（MySQL:3306、PostgreSQL:5432）
  - エンドポイント確認（マネコンで取得）

### トラブル2：ストレージ容量不足
- 症状：「Storage Full」エラー、書き込み不可
- 原因：
  - データ増加でストレージ枯渇
  - 自動ストレージスケーリング未設定
- 確認ポイント：
  - CloudWatch Metricsで使用率確認
  - 自動ストレージスケーリング有効化
  - 手動でストレージ拡張

### トラブル3：パフォーマンス低下
- 症状：クエリが遅い、タイムアウト
- 原因：
  - CPU/メモリ不足
  - ディスクI/O不足
  - スロークエリ
  - 接続数上限
- 確認ポイント：
  - CloudWatch MetricsでCPU/メモリ/IOPS確認
  - Performance Insightsで遅いクエリ特定
  - インスタンスタイプ変更検討
  - RDS Proxy導入（接続プーリング）

## 監視・ログ
- **CloudWatch Metrics**：
  - `CPUUtilization`：CPU使用率
  - `FreeableMemory`：空きメモリ
  - `FreeStorageSpace`：空きストレージ
  - `DatabaseConnections`：接続数
  - `ReadIOPS / WriteIOPS`：ディスクI/O
- **Performance Insights**：クエリ分析、ボトルネック特定
- **スローログ**：遅いクエリのログ
- **CloudWatch Alarm**：CPU・メモリ・ストレージ閾値監視

## コストでハマりやすい点
- **インスタンス課金**：インスタンスタイプ × 稼働時間
  - db.t3.micro：$0.017/時（月$12）
  - db.r5.large：$0.29/時（月$209）
- **Multi-AZ**：2倍課金（プライマリ + スタンバイ）
- **ストレージ課金**：$0.138/GB/月（gp3）
- **IOPS課金**：プロビジョンドIOPSは追加課金
- **バックアップ保存**：DB容量分は無料、超過分は課金
- **リードレプリカ**：レプリカ台数分課金
- **削除忘れ**：開発環境のRDSが稼働継続
- **コスト削減策**：
  - 開発環境は営業時間外に停止
  - リザーブドインスタンス（1年契約で40%削減）
  - ストレージはgp3（gp2より20%安い）
  - 不要なリードレプリカ削除

## 実務Tips
- **Multi-AZ必須**：本番環境は必ずMulti-AZ配置
- **Privateサブネット配置**：セキュリティ強化
- **暗号化有効化**：保管時暗号化（作成後は変更不可）
- **自動バックアップ**：7日以上推奨（最大35日）
- **メンテナンスウィンドウ**：影響少ない時間帯に設定
- **パラメータグループ**：デフォルトは編集不可、カスタム作成
- **削除保護**：本番環境は必ず有効化
- **Secrets Managerで認証情報管理**：ハードコード禁止
- **Performance Insights有効化**：クエリ分析必須
- **自動ストレージスケーリング**：有効化推奨
- **リードレプリカ活用**：読み取り負荷が高い場合
- **RDS Proxy活用**：
  - Lambda接続時（接続プーリング）
  - 接続数制限対策
  - フェイルオーバー時間短縮
- **インスタンスタイプ選定**：
  - 汎用：db.t3（バースト）、db.m5（バランス）
  - メモリ最適化：db.r5
- **設計時に言語化すると評価が上がるポイント**：
  - 「Multi-AZ配置で自動フェイルオーバー、RPO/RTO要件を満たす」
  - 「Privateサブネット配置でセキュリティ強化、インターネットからの直接アクセス不可」
  - 「リードレプリカで読み取り負荷分散、プライマリの負荷軽減」
  - 「自動バックアップ7日保持でポイントインタイムリカバリ対応」
  - 「Performance Insights有効化でスロークエリ特定、パフォーマンス改善」
  - 「Secrets Managerで認証情報管理、ローテーション自動化」
  - 「自動ストレージスケーリングでストレージ枯渇を防止」

## RDS vs Aurora

| 項目 | RDS | Aurora |
|------|-----|--------|
| エンジン | MySQL/PostgreSQL/Oracle/SQL Server | MySQL/PostgreSQL互換 |
| 可用性 | Multi-AZ（フェイルオーバー数分） | 6コピー、自動修復 |
| パフォーマンス | 標準 | 最大5倍高速 |
| レプリカ | 最大15台（非同期） | 最大15台（低レイテンシー） |
| コスト | 低い | 高い（1.5〜2倍） |
| 用途 | 標準的なワークロード | 高性能・高可用性要件 |

## 接続文字列例

```bash
# MySQL
mysql -h main-db.xxxxx.ap-northeast-1.rds.amazonaws.com \
      -P 3306 \
      -u admin \
      -p

# PostgreSQL
psql -h main-db.xxxxx.ap-northeast-1.rds.amazonaws.com \
     -p 5432 \
     -U admin \
     -d mydb
```

## メンテナンスウィンドウとバックアップウィンドウ

- **メンテナンスウィンドウ**：パッチ適用、マイナーバージョンアップ
  - 再起動が必要
  - 影響少ない時間帯（例：月曜 04:00-05:00）
- **バックアップウィンドウ**：自動バックアップ実行
  - I/O負荷が高い
  - アクセス少ない時間帯（例：03:00-04:00）
  - メンテナンスウィンドウと重複しないように
