# Amazon DynamoDB：運用と実務視点（Lv3）

## 運用で必ず使う機能
- **DynamoDB Streams**：テーブル変更のキャプチャ
- **ポイントインタイムリカバリ（PITR）**：過去35日以内の任意の時点に復元
- **GSI作成・削除**：インデックス管理
- **Export to S3**：テーブルデータをS3にエクスポート

## よくあるトラブル
### トラブル1：スロットリング（ProvisionedThroughputExceededException）
- 症状：「ProvisionedThroughputExceededException」エラー
- 原因：
  - プロビジョンドキャパシティ不足
  - ホットパーティション（特定パーティションキーへの集中）
  - GSIのキャパシティ不足
- 確認ポイント：
  - CloudWatch Metricsでスロットリング確認
  - パーティションキー設計見直し（均等分散）
  - オンデマンドモード検討
  - Auto Scaling有効化

### トラブル2：高額課金
- 症状：月末にDynamoDB課金が数万円
- 原因：
  - オンデマンドで大量アクセス
  - 不要なGSI
  - 古いデータ削除未実施
- 確認ポイント：
  - Cost ExplorerでDynamoDB課金確認
  - 読み取り・書き込みユニット数確認
  - プロビジョンドモード検討
  - TTL設定で古いデータ自動削除

### トラブル3：クエリが遅い
- 症状：GetItem/Queryが遅い
- 原因：
  - Scanを使用（全表スキャン）
  - GSI未作成
  - DAX未使用
- 確認ポイント：
  - ScanではなくQuery/GetItem使用
  - 適切なGSI作成
  - DAX（インメモリキャッシュ）導入

## 監視・ログ
- **CloudWatch Metrics**：
  - `ConsumedReadCapacityUnits`：読み取りユニット消費
  - `ConsumedWriteCapacityUnits`：書き込みユニット消費
  - `UserErrors`：クライアントエラー数
  - `SystemErrors`：サーバーエラー数
  - `ThrottledRequests`：スロットリング数
- **CloudWatch Contributor Insights**：ホットパーティション検出
- **CloudWatch Alarm**：スロットリング・エラー率監視

## コストでハマりやすい点
- **オンデマンド課金**：
  - 読み取り：$0.285/100万リクエスト
  - 書き込み：$1.4265/100万リクエスト
- **プロビジョンド課金**：
  - 読み取り：$0.00013/時/RCU
  - 書き込み：$0.00065/時/WCU
  - 固定費、予測可能
- **ストレージ**：$0.283/GB/月
- **GSI**：テーブルと同様の読み取り・書き込みユニット課金
- **バックアップ**：オンデマンドバックアップ $0.119/GB
- **リージョン間レプリケーション**：書き込みユニット2倍
- **コスト削減策**：
  - オンデマンド vs プロビジョンド選択
  - TTLで古いデータ自動削除
  - 不要なGSI削除
  - DAXでアクセス削減

## 実務Tips
- **パーティションキー設計最重要**：均等分散するキー選択
- **ソートキー活用**：時系列データ、範囲クエリ
- **オンデマンド推奨**：予測困難なワークロード
- **プロビジョンド**：予測可能、大規模（コスト削減）
- **GSI設計**：クエリパターンに応じて事前設計
- **DynamoDB Streams + Lambda**：イベント駆動処理
- **TTL設定**：自動的に古いデータ削除（無料）
- **DAX活用**：読み取り集約型ワークロード（マイクロ秒レイテンシー）
- **バッチ操作**：BatchGetItem / BatchWriteItem（最大25アイテム）
- **条件付き書き込み**：楽観的ロック実装
- **グローバルテーブル**：マルチリージョンレプリケーション
- **VPCエンドポイント**：プライベート接続
- **設計時に言語化すると評価が上がるポイント**：
  - 「パーティションキーを均等分散設計し、ホットパーティション回避」
  - 「DynamoDB Streams + Lambda でリアルタイムイベント処理」
  - 「TTL設定で古いデータ自動削除、ストレージコスト削減」
  - 「DAX導入で読み取りレイテンシーをマイクロ秒に短縮」
  - 「グローバルテーブルでマルチリージョンレプリケーション、低レイテンシー・DR対策」
  - 「オンデマンドモードで予測困難なワークロードに対応、自動スケール」
  - 「ポイントインタイムリカバリ有効化で過去35日以内の任意時点に復元可能」

## DynamoDB vs RDS

| 項目 | DynamoDB | RDS |
|------|----------|-----|
| データモデル | NoSQL（キー・バリュー） | SQL（リレーショナル） |
| スケール | 無制限、水平スケール | 垂直スケール（インスタンスサイズ） |
| レイテンシー | ミリ秒 | 数十ミリ秒 |
| 管理 | 完全マネージド | バックアップ・パッチ管理必要 |
| クエリ | シンプル（キー検索） | 複雑（JOIN、集計） |
| 用途 | 高スループット、シンプルクエリ | 複雑なクエリ、トランザクション |

## オンデマンド vs プロビジョンド

| 項目 | オンデマンド | プロビジョンド |
|------|------------|--------------|
| 課金 | 使用量に応じて | 事前確保キャパシティ |
| スケール | 自動 | Auto Scaling設定 |
| コスト | 変動（予測困難） | 固定（予測可能） |
| 用途 | 新規、予測困難 | 安定、大規模 |

## パーティションキー設計のベストプラクティス

- ❌ **悪い例**：日付（2024-01-01）→ 特定日に集中
- ✓ **良い例**：ユーザーID（uuid）→ 均等分散
- ❌ **悪い例**：ステータス（active/inactive）→ 2値に偏り
- ✓ **良い例**：注文ID（order-xxxxx）→ ランダム分散

## 操作コマンド例（AWS CLI）

```bash
# アイテム取得
aws dynamodb get-item \
  --table-name Users \
  --key '{"user_id": {"S": "user-123"}}'

# アイテム追加
aws dynamodb put-item \
  --table-name Users \
  --item '{"user_id": {"S": "user-123"}, "name": {"S": "John"}}'

# クエリ（ソートキー範囲）
aws dynamodb query \
  --table-name UserEvents \
  --key-condition-expression "user_id = :uid AND #ts BETWEEN :start AND :end" \
  --expression-attribute-names '{"#ts": "timestamp"}' \
  --expression-attribute-values '{":uid": {"S": "user-123"}, ":start": {"N": "1609459200"}, ":end": {"N": "1640995200"}}'
```
