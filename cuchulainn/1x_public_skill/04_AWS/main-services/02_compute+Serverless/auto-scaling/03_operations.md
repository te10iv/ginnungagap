# AWS Auto Scaling：運用と実務視点（Lv3）

## 運用で必ず使う機能
- **アクティビティ履歴**：スケールイン/アウトの履歴確認
- **インスタンス保護**：特定インスタンスをスケールインから除外
- **インスタンスのウォームアップ**：起動後の安定化期間
- **ライフサイクルフック**：起動/終了時のカスタム処理

## よくあるトラブル
### トラブル1：スケールアウトしない
- 症状：負荷が高いのにインスタンスが増えない
- 原因：
  - 最大台数に達している
  - クールダウン期間中
  - スケーリングポリシーの閾値が高すぎる
  - IAM権限不足
  - サブネットのIP不足
- 確認ポイント：
  - アクティビティ履歴でエラー確認
  - 現在台数と最大台数確認
  - CloudWatchメトリクスで負荷確認
  - サブネットの利用可能IP確認

### トラブル2：インスタンスがすぐにUnhealthyになる
- 症状：起動直後にヘルスチェック失敗で終了
- 原因：
  - ヘルスチェック猶予期間が短すぎる
  - アプリケーション起動に時間がかかる
  - User Dataの実行エラー
  - Security Groupでヘルスチェックがブロック
- 確認ポイント：
  - ヘルスチェック猶予期間延長（300秒→600秒）
  - EC2のシステムログ確認
  - Security GroupでALBからの通信許可

### トラブル3：スケールインで誤ったインスタンスが終了
- 症状：重要な処理中のインスタンスが終了
- 原因：
  - スケールイン保護が未設定
  - 終了ポリシーのデフォルト動作
  - Connection Draining未設定
- 確認ポイント：
  - インスタンス保護設定
  - 終了ポリシー確認（OldestInstance、NewestInstance等）
  - ALBのConnection Draining設定（デフォルト300秒）

## 監視・ログ
- **CloudWatch Metrics**：
  - `GroupDesiredCapacity`：希望容量
  - `GroupInServiceInstances`：稼働中インスタンス数
  - `GroupMinSize / GroupMaxSize`：最小/最大台数
  - スケーリングポリシーのメトリクス（CPU等）
- **アクティビティ履歴**：スケーリングイベントの履歴
- **CloudWatch Alarm**：
  - 希望容量と稼働台数の乖離
  - スケーリング失敗

## コストでハマりやすい点
- **最小台数設定ミス**：不要に多く設定（5台 → 2台で月$180削減）
- **スケールインポリシー未設定**：負荷減少時も高台数維持
- **削除忘れ**：開発環境のASGが稼働継続
- **スポット中断**：スポットインスタンス使用時の予期せぬ終了
- **コスト削減策**：
  - 最小台数は必要最小限
  - スケジュールスケーリング（夜間・休日削減）
  - スポットインスタンス活用
  - ターゲット追跡スケーリングで過剰スケール防止

## 実務Tips
- **最小台数 = AZ数**：各AZに最低1台確保（高可用性）
- **ヘルスチェック猶予期間**：アプリ起動時間 + 余裕（300〜600秒）
- **ターゲット追跡推奨**：CPU 70%等、シンプルで効果的
- **クールダウン期間**：デフォルト300秒、調整不要なケース多い
- **起動テンプレート使用**：起動設定は旧式、起動テンプレート推奨
- **複数AZ配置**：最低2AZ、本番は3AZ推奨
- **終了ポリシー**：
  - **Default**：AZ間バランス維持
  - **OldestInstance**：古いインスタンス優先削除
  - **NewestInstance**：新しいインスタンス優先削除
- **ライフサイクルフック活用**：
  - 起動時：設定ファイル取得、ウォームアップ
  - 終了時：ログ保存、クリーンアップ
- **インスタンス保護**：特定インスタンスをスケールインから除外
- **スポットインスタンス設計**：
  - オンデマンドで最小台数確保
  - スポットで追加台数
  - 複数インスタンスタイプ指定
- **設計時に言語化すると評価が上がるポイント**：
  - 「Multi-AZ構成で各AZに最低1台確保、単一AZ障害に対応」
  - 「ターゲット追跡スケーリングでCPU 70%維持、自動スケール」
  - 「スケジュールスケーリングで営業時間外は最小台数、コスト削減」
  - 「ヘルスチェック猶予期間600秒でアプリ起動時間を確保」
  - 「スポットインスタンス併用で最大90%コスト削減」
  - 「ライフサイクルフックで起動時の設定取得・終了時のログ保存を自動化」
  - 「Connection Draining 300秒で既存接続を維持したまま削除」

## スケーリングポリシーの使い分け

| ポリシー | 用途 | メリット | デメリット |
|---------|------|----------|-----------|
| ターゲット追跡 | CPU/ネットワーク維持 | シンプル、推奨 | 複雑な条件不可 |
| ステップスケーリング | 段階的スケール | 細かい制御 | 設定複雑 |
| スケジュール | 時間帯別 | 予測可能 | 突発負荷に非対応 |

## スケーリングメトリクスの選び方

- **CPU使用率**：最も一般的、70%目標推奨
- **ネットワークトラフィック**：ネットワーク集約型アプリ
- **ALBリクエスト数**：リクエスト分散重視
- **カスタムメトリクス**：アプリ固有の指標（キュー長等）
