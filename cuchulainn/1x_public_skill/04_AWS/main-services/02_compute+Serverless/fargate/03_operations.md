# AWS Fargate：運用と実務視点（Lv3）

## 運用で必ず使う機能
- **プラットフォームバージョン更新**：セキュリティパッチ適用
- **タスクメトリクス監視**：CloudWatch Container Insights
- **ECS Exec**：実行中コンテナへのシェルアクセス
- **Spot Fargate**：コスト削減（最大70%）

## よくあるトラブル
### トラブル1：タスクが起動しない（ResourceInitializationError）
- 症状：「ResourceInitializationError」でタスク起動失敗
- 原因：
  - VPCエンドポイントがない（Privateサブネット）
  - NAT Gatewayがない（Privateサブネット）
  - サブネットのIP不足
  - タスク実行ロールの権限不足
- 確認ポイント：
  - VPCエンドポイント（ecr.api, ecr.dkr, s3）確認
  - サブネットの利用可能IP確認
  - タスク実行ロールに必要権限確認

### トラブル2：パフォーマンス不足
- 症状：コンテナの処理が遅い
- 原因：
  - CPU/メモリが不足
  - タスク定義のサイジングミス
- 確認ポイント：
  - CloudWatch MetricsでCPU/メモリ使用率確認
  - タスク定義のCPU/メモリ増強（0.25 → 0.5 vCPU等）

### トラブル3：Spot中断で処理失敗
- 症状：Spot Fargateタスクが予期せず終了
- 原因：
  - Spot容量不足でタスク中断
  - 中断許容できない処理でSpot使用
- 確認ポイント：
  - 重要な処理は通常Fargate使用
  - Spot中断時の再試行ロジック実装
  - SQSキュー併用で処理継続性確保

## 監視・ログ
- **CloudWatch Metrics**：
  - `CPUUtilization`：CPU使用率
  - `MemoryUtilization`：メモリ使用率
- **CloudWatch Container Insights**：
  - タスクレベルの詳細メトリクス
  - ネットワークI/O、ディスクI/O
- **CloudWatch Logs**：コンテナの標準出力
- **CloudWatch Alarm**：CPU/メモリ閾値、タスク数

## コストでハマりやすい点
- **Fargate課金**：
  - vCPU：$0.04048/vCPU時間（東京）
  - メモリ：$0.004445/GB時間
  - 例：0.25vCPU + 0.5GB = 月約$9（常時稼働）
- **過剰スペック**：必要以上のCPU/メモリ設定
- **削除忘れ**：開発環境のタスクが稼働継続
- **Spot Fargate活用**：最大70%削減
- **コスト削減策**：
  - 適切なCPU/メモリサイジング
  - Spot Fargate活用（中断許容なワークロード）
  - 開発環境は使用時のみ起動
  - バッチ処理は実行後自動停止

## 実務Tips
- **Fargate推奨**：サーバー管理不要、セキュリティ強化
- **プラットフォームバージョン**：LATEST推奨（自動更新）
- **Privateサブネット配置必須**：セキュリティ
- **VPCエンドポイント推奨**：
  - ecr.api, ecr.dkr, s3：ECRアクセス
  - logs：CloudWatch Logs
  - NAT Gateway不要でコスト削減
- **CPU/メモリ組み合わせ**：
  - 小規模：0.25vCPU + 0.5GB
  - 中規模：0.5vCPU + 1GB
  - 大規模：1vCPU + 2GB〜
- **Spot Fargate活用**：
  - バッチ処理、非同期処理
  - 中断許容なワークロード
  - 最大70%コスト削減
- **エフェメラルストレージ**：
  - デフォルト20GB
  - 永続化不要（タスク終了で削除）
  - 永続化必要ならEFS使用
- **ネットワーク性能**：
  - タスクサイズで自動調整
  - 大きいタスクほど高速
- **起動時間**：
  - コールドスタート：数秒〜数十秒
  - EC2起動タイプより高速
- **設計時に言語化すると評価が上がるポイント**：
  - 「Fargateでサーバー管理不要、運用コスト削減」
  - 「Privateサブネット配置 + VPCエンドポイントでセキュリティ強化」
  - 「Spot Fargate併用でバッチ処理のコスト最大70%削減」
  - 「タスクレベル分離でマルチテナント環境のセキュリティ確保」
  - 「Auto Scalingで即座にスケール、EC2起動待ち不要」
  - 「Container Insights有効化で詳細メトリクス収集」

## Fargate vs Lambda vs EC2

| 項目 | Fargate | Lambda | EC2 |
|------|---------|--------|-----|
| 管理 | 不要 | 不要 | 必要 |
| 実行時間 | 無制限 | 最大15分 | 無制限 |
| 起動 | 数秒 | ミリ秒 | 数分 |
| 課金 | vCPU+メモリ時間 | 実行時間×メモリ | インスタンス時間 |
| 用途 | コンテナ常時稼働 | イベント駆動 | 長時間・大規模 |

## Fargate料金例（東京リージョン）

| CPU | メモリ | 時間単価 | 月額（常時稼働） |
|-----|--------|----------|-----------------|
| 0.25 vCPU | 0.5 GB | $0.012 | $8.64 |
| 0.5 vCPU | 1 GB | $0.024 | $17.28 |
| 1 vCPU | 2 GB | $0.049 | $35.28 |
| 2 vCPU | 4 GB | $0.099 | $71.28 |

※ Spot Fargateは最大70%削減

## Spot Fargate使用時の注意

- **中断通知**：120秒前に通知（SIGTERM）
- **Graceful Shutdown実装**：シグナル受信時の処理
- **適用ワークロード**：
  - ✓ バッチ処理
  - ✓ 非同期処理
  - ✓ キュー処理
  - ✗ リアルタイムAPI
  - ✗ Webフロントエンド
- **再試行ロジック**：中断時の自動再試行実装
