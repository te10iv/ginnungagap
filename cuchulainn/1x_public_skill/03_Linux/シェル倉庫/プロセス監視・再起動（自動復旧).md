# プロセス監視・再起動（自動復旧)

## 概要

指定したプロセス（サービス）が停止しているかどうかを監視し、停止を検知した場合に自動的に再起動するシェルスクリプトです。cronなどで定期的に実行することで、プロセスの自動復旧機能を実現します。

## 前提

- サーバ内でapache(httpd)を起動している
- `pgrep`コマンドが利用可能である
- `systemctl`コマンドが利用可能である（systemd環境）
- スクリプト実行ユーザーが対象サービスの再起動権限を持っている
- ログファイルの書き込み権限がある（`/var/log/process_monitor.log`）

## 解説

```bash
#!/usr/bin/env bash
# プロセス監視と自動再起動スクリプト
# 監視対象プロセスが落ちたら自動で起動する

PROCESS="httpd"
# 監視対象プロセス名（例：nginx, httpd, mysqldなど）

SERVICE_CMD="systemctl restart $PROCESS"
# 再起動コマンド

LOGFILE="/var/log/process_monitor.log"

if pgrep -x "$PROCESS" > /dev/null; then
  # pgrepでプロセス名一致確認
  echo "$(date '+%F %T') OK: $PROCESS 稼働中" >> "$LOGFILE"
else
  echo "$(date '+%F %T') ALERT: $PROCESS 停止検知、再起動実行" >> "$LOGFILE"
  $SERVICE_CMD
fi
```

### スクリプトの動作

1. **プロセス確認**: `pgrep -x "$PROCESS"`で指定したプロセス名が実行中か確認
   - `-x`オプション: プロセス名が完全一致するもののみ検索
2. **ログ記録**: プロセスの状態（稼働中/停止）をログファイルに記録
3. **自動再起動**: プロセスが停止している場合、`systemctl restart`で再起動

### 使用方法

1. スクリプトに実行権限を付与
   ```bash
   chmod +x process_monitor.sh
   ```

2. cronで定期実行（例: 5分ごと）
   ```bash
   */5 * * * * /path/to/process_monitor.sh
   ```

3. ログの確認
   ```bash
   tail -f /var/log/process_monitor.log
   ```

## 補足

- **監視対象プロセスの変更**: `PROCESS`変数を変更することで、nginx、mysqldなど他のプロセスも監視可能
- **再起動コマンドのカスタマイズ**: `SERVICE_CMD`変数を変更することで、`service`コマンドや直接起動コマンドにも対応可能
- **ログファイルの場所**: 必要に応じて`LOGFILE`変数を変更（例: `~/logs/process_monitor.log`）
- **権限の問題**: `/var/log/`に書き込む場合は、root権限で実行するか、適切な権限設定が必要
- **cronの設定**: 監視間隔は用途に応じて調整（1分ごと、5分ごとなど）
- **注意点**: プロセスが頻繁に落ちる場合は、根本原因の調査が必要
