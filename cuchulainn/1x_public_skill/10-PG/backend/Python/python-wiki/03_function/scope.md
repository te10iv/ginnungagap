# スコープ

## 1. 要点まとめ

- スコープは変数の有効範囲を表す
- ローカル変数は関数内でのみ有効
- グローバル変数は関数の外で定義された変数
- 関数内でグローバル変数を変更するには`global`キーワードが必要
- 関数内からグローバル変数を参照するだけなら`global`は不要
- ネストした関数では`nonlocal`キーワードで外側の関数の変数にアクセスできる

## 2. 詳細解説

スコープは、変数の有効範囲を表す概念です。Pythonには主に3つのスコープがあります。

ローカルスコープは、関数内で定義された変数が有効な範囲です。関数内で定義した変数は、その関数内でのみアクセスできます。関数の外からはアクセスできません。

グローバルスコープは、関数の外で定義された変数が有効な範囲です。グローバル変数は、関数内からも参照できます。ただし、関数内でグローバル変数を変更する場合は、`global`キーワードで宣言する必要があります。

ビルトインスコープは、Pythonの組み込み関数や定数が有効な範囲です。`print`、`len`、`range`などがこれに該当します。

ネストした関数（関数内で定義された関数）では、`nonlocal`キーワードを使って、外側の関数の変数にアクセスできます。

## 3. サンプルコード

```python
# グローバル変数
global_var = "グローバル変数"

def func1():
    # ローカル変数
    local_var = "ローカル変数"
    print(local_var)  # ローカル変数内でアクセス可能
    print(global_var)  # グローバル変数を参照（global不要）

func1()
# print(local_var)  # エラー: ローカル変数にはアクセスできない

# グローバル変数の変更
count = 0

def increment():
    global count  # globalキーワードで宣言
    count += 1  # グローバル変数を変更

increment()
print(count)  # 1

# グローバル変数の参照のみ（global不要）
name = "太郎"

def greet():
    print(f"こんにちは、{name}さん")  # 参照のみなのでglobal不要

greet()

# ネストした関数とnonlocal
def outer():
    outer_var = "外側の変数"
    
    def inner():
        nonlocal outer_var  # nonlocalで外側の関数の変数にアクセス
        outer_var = "変更されました"
        print(outer_var)
    
    inner()
    print(outer_var)

outer()

# 変数の優先順位
x = "グローバル"

def test():
    x = "ローカル"  # ローカル変数が優先される
    print(x)  # "ローカル"

test()
print(x)  # "グローバル"
```

## 4. 注意点・落とし穴

- **グローバル変数の変更**: 関数内でグローバル変数を変更する場合は、必ず`global`キーワードで宣言する必要があります。宣言しないと、同名のローカル変数が作成されます
- **グローバル変数の参照**: グローバル変数を参照するだけなら`global`は不要です。ただし、変更する場合は必要です
- **変数の優先順位**: ローカル変数とグローバル変数で同じ名前がある場合、ローカル変数が優先されます
- **`nonlocal`の使用**: ネストした関数で外側の関数の変数を変更する場合は、`nonlocal`キーワードが必要です
- **グローバル変数の多用**: グローバル変数を多用すると、コードの可読性が低下します。可能な限りローカル変数を使いましょう

## 5. 演習問題

1. グローバル変数`counter`を定義し、関数`increment()`でその値を1増やすプログラムを作成してください
2. 関数内でローカル変数とグローバル変数で同じ名前を使い、それぞれの値を表示するプログラムを作成してください
3. ネストした関数を使って、外側の関数の変数を変更するプログラムを作成してください

## 6. 解答例

```python
# 1. グローバル変数の変更
counter = 0

def increment():
    global counter
    counter += 1

increment()
print(counter)  # 1

# 2. ローカル変数とグローバル変数
x = "グローバル"

def test():
    x = "ローカル"
    print(f"関数内: {x}")  # "ローカル"

test()
print(f"関数外: {x}")  # "グローバル"

# 3. nonlocalの使用
def outer():
    value = 10
    
    def inner():
        nonlocal value
        value = 20
        print(f"内側: {value}")
    
    print(f"外側（変更前）: {value}")
    inner()
    print(f"外側（変更後）: {value}")

outer()
```
